<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lista de Asistencia - EC0301</title>
  <link rel="stylesheet" href="/assets/common.css">
  <style>
    .toolbar{display:flex;gap:1rem;margin-bottom:1rem}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.8rem;text-align:left}
    th{background:#f9fafb}
    input[type=number]{width:80px;padding:.5rem;border:2px solid var(--border);border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <a class="btn btn-secondary" href="/"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
      <button class="btn btn-primary" onclick="generatePDF()"><i class="fa-solid fa-file-pdf"></i> Generar PDF</button>
      <button class="btn btn-primary" onclick="markComplete()"><i class="fa-solid fa-check"></i> Marcar 100%</button>
    </div>
    <h2 class="section-title">Lista de Asistencia</h2>
    <div>
      <strong>Curso:</strong> <span id="hd_curso"></span><br>
      <strong>Instructor:</strong> <span id="hd_instructor"></span><br>
      <strong>Lugar:</strong> <span id="hd_lugar"></span><br>
      <strong>Fecha:</strong> <span id="hd_fecha"></span>
    </div>
    <div style="margin:1rem 0">
      <label>NÃºmero de participantes:</label>
      <input type="number" id="numParticipants" min="1" value="10" onchange="renderTable()">
    </div>
    <div style="overflow:auto">
      <table id="attTable">
        <thead>
          <tr><th>No.</th><th>Nombre</th><th>Firma</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const KEY_CARTA='EC0301_CARTA';
    function loadHeader(){
      const d=JSON.parse(localStorage.getItem(KEY_CARTA)||'{}');
      ['curso','instructor','lugar','fecha'].forEach(k=>{
        document.getElementById('hd_'+k).textContent = d[k]||'';
      });
    }
    function renderTable(){
      const n=parseInt(document.getElementById('numParticipants').value)||0;
      const tbody=document.querySelector('#attTable tbody');
      tbody.innerHTML='';
      for(let i=1;i<=n;i++){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i}</td><td></td><td></td>`;
        tbody.appendChild(tr);
      }
    }
    function generatePDF(){
      const data={ header: {
        curso:hd_curso.textContent,
        instructor:hd_instructor.textContent,
        lugar:hd_lugar.textContent,
        fecha:hd_fecha.textContent
      }, num: parseInt(numParticipants.value)||0 };
      fetch('/api/generate-attendance-pdf',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      }).then(r=>r.blob()).then(blob=>{
        const url=URL.createObjectURL(blob), a=document.createElement('a');
        a.href=url; a.download=`Lista_Asistencia_${new Date().toISOString().slice(0,10)}.pdf`;
        a.click();
      });
    }
    function markComplete(){ parent?.postMessage({deliverable:8,progress:100},'*'); }
    document.addEventListener('DOMContentLoaded',()=>{
      loadHeader(); renderTable();
    });
  </script>
  <script src="/assets/common.js"></script>
</body>
</html>
