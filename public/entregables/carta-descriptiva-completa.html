<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carta Descriptiva EC0301 - Global Skills Cert S.C.</title>
    <link rel="stylesheet" href="/assets/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --accent: #FF6B35; --deep: #1E3A8A; }
        .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; }
        .section { background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, .08); padding: 1.5rem; margin: 1rem 0; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .pill { display: inline-flex; gap: .5rem; align-items: center; padding: .35rem .75rem; border-radius: 20px; background: rgba(30, 58, 138, .08); color: #1E3A8A; font-weight: 700; font-size: .8rem; }
        .muted { color: var(--muted); font-size: .9rem; }
        textarea, input, select { border: 2px solid var(--border); border-radius: 8px; padding: .75rem; width: 100%; }
        textarea { min-height: 120px; resize: vertical; }
        .box { border: 2px solid var(--border); border-radius: 10px; padding: 1rem; background: #fff; margin-top: 1rem; }
        .doms { display: grid; grid-template-columns: repeat(4, 1fr); gap: .5rem; }
        .dom { border: 2px solid var(--border); border-radius: 10px; padding: .7rem; text-align: center; cursor: pointer; transition: all .2s; }
        .dom.active { border-color: var(--accent); background: #fff5f0; font-weight: bold; }
        .verbo { display: inline-block; background: #F1F5F9; border: 1px solid var(--border); padding: .35rem .6rem; margin: .2rem; border-radius: 20px; cursor: pointer; font-size: .85rem; transition: background .2s; }
        .verbo:hover { background: #e2e8f0; }
        .time { display: inline-block; background: #1E3A8A; color: #fff; border-radius: 20px; padding: .25rem .6rem; font-weight: 700; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row">
                <h1><i class="fa-solid fa-file-alt" style="color:#FF6B35"></i> Carta Descriptiva EC0301</h1>
                <div class="toolbar">
                    <a class="btn btn-secondary" href="/"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
                    <button class="btn btn-secondary" onclick="loadDraft()"><i class="fa-solid fa-download"></i> Cargar borrador</button>
                    <button class="btn btn-primary" onclick="saveDraft()"><i class="fa-solid fa-save"></i> Guardar</button>
                    <button class="btn btn-primary" onclick="exportCarta('pdf')"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
                    <button class="btn btn-primary" onclick="exportCarta('docx')"><i class="fa-solid fa-file-word"></i> Exportar Word</button>
                    <button class="btn btn-primary" onclick="markComplete()"><i class="fa-solid fa-check"></i> Marcar 100%</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2 class="section-title">1) Información general</h2>
            <div class="grid-2">
                <input id="cd_nombre" placeholder="Nombre del Curso - Taller">
                <input id="cd_duracion" placeholder="Duración total (horas)">
                <input id="cd_diseñador" placeholder="Nombre del diseñador">
                <input id="cd_facilitador" placeholder="Nombre del facilitador/instructor">
                <input id="cd_lugar" placeholder="Lugar de instrucción (dirección)">
                <input id="cd_fechas" placeholder="Fechas de impartición (ej. 15-19 enero 2025)">
                <input id="cd_horario" placeholder="Horario (ej. 09:00-17:00)">
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">2) Perfil del participante</h2>
            <div class="grid-2">
                <textarea id="cd_psico" placeholder="Características psicográficas (ocupación, edad, etc.)"></textarea>
                <textarea id="cd_conoc" placeholder="Conocimientos previos requeridos"></textarea>
                <textarea id="cd_hab" placeholder="Habilidades previas requeridas"></textarea>
                <input id="cd_num" placeholder="Número de participantes (mín-máx)">
                <select id="cd_tipo">
                    <option value="">Tipo de grupo...</option>
                    <option value="homogeneo">Homogéneo</option>
                    <option value="heterogeneo">Heterogéneo</option>
                    <option value="mixto">Mixto</option>
                </select>
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">3) Objetivos</h2>
            <div class="box">
                <h3>Objetivo general</h3>
                <div class="grid-2">
                    <input value="El participante" disabled>
                    <select id="og_dom">
                        <option value="">Dominio principal...</option>
                        <option value="cognitivo">Cognitivo</option>
                        <option value="psicomotriz">Psicomotriz</option>
                        <option value="afectivo">Afectivo</option>
                        <option value="relacional">Relacional-Social</option>
                    </select>
                </div>
                <textarea id="og_accion" placeholder="Acción/Comportamiento (Al finalizar el curso...)" class="mt-1"></textarea>
                <textarea id="og_cond" placeholder="Condición de operación (cómo y para qué)" class="mt-1"></textarea>
                <div class="muted">Vista previa: <em id="og_preview">Complete los campos...</em></div>
            </div>
            <div class="box" id="op1">
                <h3>Objetivo particular 1</h3>
                <div class="doms">
                    <div class="dom active" data-op="1" data-d="cognitivo" onclick="selDom(1, 'cognitivo')">Cognitivo</div>
                    <div class="dom" data-op="1" data-d="psicomotriz" onclick="selDom(1, 'psicomotriz')">Psicomotriz</div>
                    <div class="dom" data-op="1" data-d="afectivo" onclick="selDom(1, 'afectivo')">Afectivo</div>
                    <div class="dom" data-op="1" data-d="relacional" onclick="selDom(1, 'relacional')">Relacional</div>
                </div>
                <div id="verbs1" style="margin:.5rem 0"></div>
                <div class="grid-2">
                    <input id="op1_accion" placeholder="Acción/Comportamiento">
                    <textarea id="op1_cond" placeholder="Condición de operación"></textarea>
                </div>
                <textarea id="op1_temas" placeholder="Temas relacionados (uno por línea)" class="mt-1"></textarea>
            </div>
            <div class="box" id="op2">
                <h3>Objetivo particular 2</h3>
                <div class="doms">
                    <div class="dom" data-op="2" data-d="cognitivo" onclick="selDom(2, 'cognitivo')">Cognitivo</div>
                    <div class="dom active" data-op="2" data-d="psicomotriz" onclick="selDom(2, 'psicomotriz')">Psicomotriz</div>
                    <div class="dom" data-op="2" data-d="afectivo" onclick="selDom(2, 'afectivo')">Afectivo</div>
                    <div class="dom" data-op="2" data-d="relacional" onclick="selDom(2, 'relacional')">Relacional</div>
                </div>
                <div id="verbs2" style="margin:.5rem 0"></div>
                <div class="grid-2">
                    <input id="op2_accion" placeholder="Acción/Comportamiento">
                    <textarea id="op2_cond" placeholder="Condición de operación"></textarea>
                </div>
                <textarea id="op2_temas" placeholder="Temas relacionados (uno por línea)" class="mt-1"></textarea>
            </div>
            <div class="box" id="op3">
                <h3>Objetivo particular 3</h3>
                <div class="doms">
                    <div class="dom" data-op="3" data-d="cognitivo" onclick="selDom(3, 'cognitivo')">Cognitivo</div>
                    <div class="dom" data-op="3" data-d="psicomotriz" onclick="selDom(3, 'psicomotriz')">Psicomotriz</div>
                    <div class="dom active" data-op="3" data-d="afectivo" onclick="selDom(3, 'afectivo')">Afectivo</div>
                    <div class="dom" data-op="3" data-d="relacional" onclick="selDom(3, 'relacional')">Relacional</div>
                </div>
                <div id="verbs3" style="margin:.5rem 0"></div>
                <div class="grid-2">
                    <input id="op3_accion" placeholder="Acción/Comportamiento">
                    <textarea id="op3_cond" placeholder="Condición de operación"></textarea>
                </div>
                <textarea id="op3_temas" placeholder="Temas relacionados (uno por línea)" class="mt-1"></textarea>
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">4) Requerimientos</h2>
            <div class="grid-2">
                <textarea id="rq_inst" placeholder="Instalaciones, mobiliario y distribución"></textarea>
                <textarea id="rq_equipo" placeholder="Equipo de apoyo y distribución"></textarea>
                <textarea id="rq_mats" placeholder="Materiales de apoyo (incluya formatos)"></textarea>
                <textarea id="rq_rh" placeholder="Requerimientos humanos"></textarea>
                <textarea id="rq_otros" placeholder="Otros requerimientos"></textarea>
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">5) Evaluación</h2>
            <div class="grid-3">
                <select id="ev_min">
                    <option value="">% mínimo de aprobación...</option>
                    <option>70</option><option selected>80</option><option>85</option><option>90</option>
                </select>
                <input id="ev_diag_mom" placeholder="Diagnóstica: Momento (ej. inicio 15 min)">
                <input id="ev_diag_ins" placeholder="Diagnóstica: Instrumento (ej. cuestionario)">
                <select id="ev_form_pct">
                    <option value="">Formativa %...</option>
                    <option>30</option><option selected>40</option><option>50</option>
                </select>
                <input id="ev_form_mom" placeholder="Formativa: Momento">
                <input id="ev_form_ins" placeholder="Formativa: Instrumento (lista de cotejo)">
                <input id="ev_sum_mom" placeholder="Sumativa: Momento (ej. cierre)">
                <input id="ev_sum_ins" placeholder="Sumativa: Instrumento (examen + caso)">
                <input id="ev_sum_pct" placeholder="Sumativa % (auto)" disabled>
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">6) Desarrollo cronológico</h2>
            <div class="box">
                <h3>Comprobación de recursos <span class="time">30 min previos</span></h3>
                <textarea id="dc_comp" placeholder="Lista de verificación, pruebas de equipo, distribución de mobiliario, materiales..."></textarea>
            </div>
            <div class="box">
                <h3>Apertura / Encuadre</h3>
                <div class="grid-3">
                    <input id="dc_pres_t" placeholder="Presentación: duración (min)" value="15">
                    <input id="dc_curso_t" placeholder="Presentación del curso: duración (min)" value="10">
                    <input id="dc_eval_t" placeholder="Explicación evaluación: duración (min)" value="5">
                </div>
                <textarea id="dc_pres_act" placeholder="Actividades de presentación y rompehielo"></textarea>
                <textarea id="dc_curso_act" placeholder="Actividades de presentación del curso"></textarea>
                <textarea id="dc_eval_act" placeholder="Explicación de momentos e instrumentos de evaluación"></textarea>
                <textarea id="dc_acuerdos" placeholder="Acuerdos y compromisos + aplicación diagnóstica"></textarea>
            </div>
            <div class="box">
                <h3>Desarrollo</h3>
                <div class="grid-3">
                    <input id="dc_exp_t" placeholder="Técnica expositiva (min)" value="120">
                    <input id="dc_dem_t" placeholder="Técnica demostrativa (min)" value="150">
                    <input id="dc_dial_t" placeholder="Diálogo-discusión (min)" value="90">
                </div>
                <textarea id="dc_exp_act" placeholder="Expositiva: objetivos, recuperación de experiencia, contenidos, síntesis..."></textarea>
                <textarea id="dc_dem_act" placeholder="Demostrativa: objetivo, ejemplo paso a paso, práctica supervisada, retro..."></textarea>
                <textarea id="dc_dial_act" placeholder="Diálogo-discusión: reglas, moderación, verificación de comprensión..."></textarea>
            </div>
            <div class="box">
                <h3>Cierre <span class="time">15-20 min</span></h3>
                <textarea id="dc_cierre" placeholder="Resumen, logro de expectativas/objetivos, sugerencias, compromisos, encuesta"></textarea>
            </div>
            <div class="box">
                <h3>Sumatorias de tiempo</h3>
                <div class="grid-3">
                    <input id="sum_encuadre" placeholder="Encuadre (min)" disabled>
                    <input id="sum_desarrollo" placeholder="Desarrollo (min)" disabled>
                    <input id="sum_total" placeholder="Total (h m)" disabled>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ========= Claves de almacenamiento =========
    const KEY = 'EC0301_CARTA'; // Usada por otros módulos (p.ej., evaluación diagnóstica)

    // ========= Datos =========
    const verbos = {
        cognitivo: ['Identificar', 'Comprender', 'Aplicar', 'Analizar', 'Evaluar', 'Crear'],
        psicomotriz: ['Imitar', 'Manipular', 'Demostrar', 'Coordinar', 'Integrar', 'Diseñar'],
        afectivo: ['Escuchar', 'Participar', 'Valorar', 'Organizar', 'Actuar'],
        relacional: ['Interactuar', 'Colaborar', 'Liderar', 'Facilitar', 'Negociar', 'Mediar']
    };

    // ==== util ====
    const $ = id => document.getElementById(id);

    function toast(msg, type = 'info') {
        // Enviar a un posible iframe padre para mostrar notificaciones unificadas
        window.parent?.postMessage({ __toast: msg, __type: type }, '*');
    }

    // ==== verbos sugeridos ====
    function renderVerbos(n, dom = 'cognitivo') {
        const cont = $(`verbs${n}`);
        cont.innerHTML = (verbos[dom] || []).map(v => `<span class="verbo" onclick="insVerbo(${n},'${v}')">${v}</span>`).join('');
    }

    function insVerbo(n, v) {
        const inp = $(`op${n}_accion`);
        const currentText = inp.value.trim();
        // AJUSTE: Inserta el verbo al inicio sin borrar el resto del texto.
        // Reemplaza solo el primer verbo si ya existe.
        if (currentText) {
            inp.value = v + ' ' + currentText.replace(/^[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+\s*/, '');
        } else {
            inp.value = v + ' ';
        }
        inp.focus();
        saveDraft();
    }

    function selDom(n, dom) {
        document.querySelectorAll(`#op${n} .dom`).forEach(d => d.classList.remove('active'));
        document.querySelector(`#op${n} .dom[data-d="${dom}"]`).classList.add('active');
        renderVerbos(n, dom);
        saveDraft();
    }

    // ==== objetivo general preview ====
    function updateOG() {
        const sujeto = 'El participante';
        const acc = $('og_accion').value.trim();
        const cond = $('og_cond').value.trim();
        let p = sujeto;
        if (acc) p += ', ' + acc;
        if (cond) p += ', ' + cond;
        $('og_preview').textContent = p || 'Complete los campos...';
    }
    
    // ==== sumatorias ====
    function recalcTimes() {
        const n = id => parseInt($(id).value) || 0;
        const encuadre = n('dc_pres_t') + n('dc_curso_t') + n('dc_eval_t') + 5; // +5 por acuerdos
        const desarrollo = n('dc_exp_t') + n('dc_dem_t') + n('dc_dial_t');
        const cierre = 20; // Tiempo fijo estimado para cierre
        const totalMin = encuadre + desarrollo + cierre;

        $('sum_encuadre').value = encuadre + ' min';
        $('sum_desarrollo').value = desarrollo + ' min';
        $('sum_total').value = `${Math.floor(totalMin / 60)}h ${totalMin % 60}m`;
        
        const formPct = parseInt($('ev_form_pct').value) || 0;
        // AJUSTE: Lógica clara para el % sumativo
        $('ev_sum_pct').value = (100 - formPct) + '%';
    }

    // ==== guardado / carga ====
    function collectData() {
        const getDom = (n) => document.querySelector(`#op${n} .dom.active`)?.dataset.d || 'cognitivo';
        return {
            nombre: $('cd_nombre').value, duracion: $('cd_duracion').value, diseñador: $('cd_diseñador').value,
            instructor: $('cd_facilitador').value, lugar: $('cd_lugar').value, fechas: $('cd_fechas').value,
            horario: $('cd_horario').value, psico: $('cd_psico').value, conoc: $('cd_conoc').value,
            hab: $('cd_hab').value, num: $('cd_num').value, tipo: $('cd_tipo').value,
            og: { dom: $('og_dom').value, acc: $('og_accion').value, cond: $('og_cond').value },
            op1: { dom: getDom(1), accion: $('op1_accion').value, cond: $('op1_cond').value, temas: $('op1_temas').value },
            op2: { dom: getDom(2), accion: $('op2_accion').value, cond: $('op2_cond').value, temas: $('op2_temas').value },
            op3: { dom: getDom(3), accion: $('op3_accion').value, cond: $('op3_cond').value, temas: $('op3_temas').value },
            rq: { inst: $('rq_inst').value, eq: $('rq_equipo').value, mats: $('rq_mats').value, rh: $('rq_rh').value, otros: $('rq_otros').value },
            ev: {
                min: $('ev_min').value,
                diag: { mom: $('ev_diag_mom').value, ins: $('ev_diag_ins').value },
                form: { pct: $('ev_form_pct').value, mom: $('ev_form_mom').value, ins: $('ev_form_ins').value },
                sum: { pct: $('ev_sum_pct').value, mom: $('ev_sum_mom').value, ins: $('ev_sum_ins').value }
            },
            dc: {
                comp: $('dc_comp').value,
                pres: { t: $('dc_pres_t').value, act: $('dc_pres_act').value },
                curso: { t: $('dc_curso_t').value, act: $('dc_curso_act').value },
                eva: { t: $('dc_eval_t').value, act: $('dc_eval_act').value },
                acuerdos: $('dc_acuerdos').value,
                exp: { t: $('dc_exp_t').value, act: $('dc_exp_act').value },
                dem: { t: $('dc_dem_t').value, act: $('dc_dem_act').value },
                dial: { t: $('dc_dial_t').value, act: $('dc_dial_act').value },
                cierre: $('dc_cierre').value
            },
            temas: `${$('op1_temas').value}\n${$('op2_temas').value}\n${$('op3_temas').value}`
        };
    }

    function fillForm(d) {
        if (!d) return;
        // Asignación masiva para limpieza
        Object.keys(d).forEach(k => {
            if (typeof d[k] === 'string' && $(`cd_${k}`)) $(`cd_${k}`).value = d[k];
        });
        $('cd_facilitador').value = d.instructor || ''; // Mapeo de campos
        if (d.og) { $('og_dom').value = d.og.dom || ''; $('og_accion').value = d.og.acc || ''; $('og_cond').value = d.og.cond || ''; }
        if (d.op1) { selDom(1, d.op1.dom); $('op1_accion').value = d.op1.accion || ''; $('op1_cond').value = d.op1.cond || ''; $('op1_temas').value = d.op1.temas || ''; }
        if (d.op2) { selDom(2, d.op2.dom); $('op2_accion').value = d.op2.accion || ''; $('op2_cond').value = d.op2.cond || ''; $('op2_temas').value = d.op2.temas || ''; }
        if (d.op3) { selDom(3, d.op3.dom); $('op3_accion').value = d.op3.accion || ''; $('op3_cond').value = d.op3.cond || ''; $('op3_temas').value = d.op3.temas || ''; }
        if (d.rq) { $('rq_inst').value = d.rq.inst || ''; $('rq_equipo').value = d.rq.eq || ''; $('rq_mats').value = d.rq.mats || ''; $('rq_rh').value = d.rq.rh || ''; $('rq_otros').value = d.rq.otros || ''; }
        if (d.ev) {
            $('ev_min').value = d.ev.min || '';
            if (d.ev.diag) { $('ev_diag_mom').value = d.ev.diag.mom || ''; $('ev_diag_ins').value = d.ev.diag.ins || ''; }
            if (d.ev.form) { $('ev_form_pct').value = d.ev.form.pct || ''; $('ev_form_mom').value = d.ev.form.mom || ''; $('ev_form_ins').value = d.ev.form.ins || ''; }
            if (d.ev.sum) { $('ev_sum_mom').value = d.ev.sum.mom || ''; $('ev_sum_ins').value = d.ev.sum.ins || ''; }
        }
        if (d.dc) {
            $('dc_comp').value = d.dc.comp || ''; $('dc_acuerdos').value = d.dc.acuerdos || ''; $('dc_cierre').value = d.dc.cierre || '';
            if (d.dc.pres) { $('dc_pres_t').value = d.dc.pres.t || ''; $('dc_pres_act').value = d.dc.pres.act || ''; }
            if (d.dc.curso) { $('dc_curso_t').value = d.dc.curso.t || ''; $('dc_curso_act').value = d.dc.curso.act || ''; }
            if (d.dc.eva) { $('dc_eval_t').value = d.dc.eva.t || ''; $('dc_eval_act').value = d.dc.eva.act || ''; }
            if (d.dc.exp) { $('dc_exp_t').value = d.dc.exp.t || ''; $('dc_exp_act').value = d.dc.exp.act || ''; }
            if (d.dc.dem) { $('dc_dem_t').value = d.dc.dem.t || ''; $('dc_dem_act').value = d.dc.dem.act || ''; }
            if (d.dc.dial) { $('dc_dial_t').value = d.dc.dial.t || ''; $('dc_dial_act').value = d.dc.dial.act || ''; }
        }
        updateOG();
        recalcTimes();
    }

    function saveDraft() {
        const d = collectData();
        // AJUSTE: Se elimina línea duplicada. Se guarda el estado actual en LocalStorage.
        localStorage.setItem(KEY, JSON.stringify(d));
        toast('Carta guardada', 'ok');
    }

    function loadDraft() {
        try {
            const data = JSON.parse(localStorage.getItem(KEY) || '{}');
            fillForm(data);
            toast('Carta cargada', 'ok');
        } catch {
            toast('No fue posible cargar el borrador', 'err');
        }
    }

    function exportCarta(kind) {
        const d = collectData();
        // Placeholder para exportación. Integrar librerías como jsPDF o docx para una exportación real.
        let out = `CARTA DESCRIPTIVA EC0301\n\n` +
            `INFORMACIÓN GENERAL\n` +
            `Nombre del curso: ${d.nombre}\nDiseñador: ${d.diseñador}\nFacilitador: ${d.instructor}\n` +
            `Lugar: ${d.lugar}\nDuración: ${d.duracion} hrs\nFechas: ${d.fechas}\nHorario: ${d.horario}\n\n` +
            `PERFIL DEL PARTICIPANTE\n... (se omiten detalles para brevedad) ...\n\n` +
            `OBJETIVO GENERAL\nEl participante, ${d.og.acc}, ${d.og.cond}\n\n... (resto de la exportación) ...\n\n` +
            `SUMATORIAS\nEncuadre: ${$('sum_encuadre').value}\nDesarrollo: ${$('sum_desarrollo').value}\nTotal: ${$('sum_total').value}\n`;
        
        const a = document.createElement('a');
        const fname = `Carta_Descriptiva_${new Date().toISOString().slice(0, 10)}.${kind === 'pdf' ? 'txt' : 'docx'}`;
        a.href = URL.createObjectURL(new Blob([out], { type: 'text/plain' }));
        a.download = fname;
        a.click();
        toast('Documento exportado (placeholder).', 'ok');
    }

    function markComplete() {
        // Guarda una última vez para asegurar que los datos están actualizados para otros módulos
        saveDraft();
        parent?.postMessage({ deliverable: 'carta-descriptiva', progress: 100 }, '*');
        toast('Carta marcada al 100%', 'ok');
    }

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        ['og_accion', 'og_cond'].forEach(id => $(id).addEventListener('input', updateOG));
        ['dc_pres_t', 'dc_curso_t', 'dc_eval_t', 'dc_exp_t', 'dc_dem_t', 'dc_dial_t', 'ev_form_pct'].forEach(id => {
            $(id).addEventListener('input', recalcTimes);
        });
        
        renderVerbos(1, 'cognitivo');
        renderVerbos(2, 'psicomotriz');
        renderVerbos(3, 'afectivo');
        
        recalcTimes();
        loadDraft();
    });
    </script>
</body>
</html>
