<!-- public/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EC0301 Generator Pro</title>
  <link rel="stylesheet" href="/assets/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="row">
        <h1><i class="fa-solid fa-graduation-cap" style="color:#FF6B35"></i> EC0301 Generator Pro</h1>
        <div>
          <button class="btn btn-secondary" onclick="showPage('landing')"><i class="fa-solid fa-house"></i> Inicio</button>
          <button class="btn btn-primary" onclick="showPage('payment')"><i class="fa-solid fa-credit-card"></i> Adquirir Licencia</button>
          <button class="btn btn-primary" onclick="showPage('registration')"><i class="fa-solid fa-right-to-bracket"></i> Registro</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Páginas -->
  <div id="landing" class="container page">
    <div class="card">
      <h2 class="section-title">Sistema profesional para productos EC0301</h2>
      <p style="color:var(--muted)">Genera los entregables con calidad editorial, PDFs listos y auditoría contra el EC.</p>
      <div style="display:flex;gap:.75rem;margin-top:1rem">
        <button class="btn btn-primary" onclick="showPage('dashboard')"><i class="fa-solid fa-rocket"></i> Acceso Demo</button>
        <button class="btn btn-secondary" onclick="showPage('payment')"><i class="fa-solid fa-cart-shopping"></i> Comprar Licencia</button>
      </div>
    </div>
  </div>

  <!-- Pago -->
  <div id="payment" class="container page" style="display:none">
    <div class="card">
      <h2 class="section-title"><i class="fa-solid fa-credit-card"></i> Pago</h2>
      <div class="grid">
        <div>
          <div class="card" style="background:#f9fafb">
            <h3>Resumen</h3>
            <p>Licencia EC0301 Pro (3 meses) — <strong>$2,500 MXN</strong></p>
            <div class="badge badge-warn"><i class="fa-solid fa-shield-halved"></i> Tarjeta de prueba: 4111 1111 1111 1111</div>
          </div>
        </div>
        <div>
          <form id="payForm" onsubmit="processPayment(event)">
            <div class="grid">
              <input required id="cardNumber" placeholder="4111 1111 1111 1111" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
              <div class="grid" style="grid-template-columns:1fr 1fr;gap:.75rem">
                <input required id="cardExpiry" placeholder="12/26" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
                <input required id="cardCVV" placeholder="123" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
              </div>
              <input required id="cardName" placeholder="Nombre del titular" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
              <button class="btn btn-primary" type="submit"><i class="fa-solid fa-lock"></i> Pagar $2,500 MXN</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Registro -->
  <div id="registration" class="container page" style="display:none">
    <div class="card">
      <h2 class="section-title"><i class="fa-solid fa-user-plus"></i> Registro</h2>
      <div id="accessBox" class="card" style="background:#1E3A8A;color:#fff">
        <h3>Clave de Acceso</h3>
        <p id="accessKey" style="font-size:1.25rem;font-weight:800">EC01-DEMO-2025</p>
        <small id="accessExpiry">Vigencia: 12/01/2025</small>
      </div>
      <form id="regForm" onsubmit="completeRegistration(event)">
        <div class="grid">
          <input required id="regName" placeholder="Nombre completo" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
          <input required type="email" id="regEmail" placeholder="correo@ejemplo.com" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
          <input required id="regWhats" placeholder="+52 123 456 7890" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
          <input required id="regKey" placeholder="EC01-XXXX-XXXX" style="padding:.8rem;border:2px solid var(--border);border-radius:8px">
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-right-to-bracket"></i> Registrar y Acceder</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="container page" style="display:none">
    <div class="card">
      <h2 class="section-title"><i class="fa-solid fa-folder-open"></i> Entregables EC0301 (10 formatos)</h2>

      <!-- Agrupación por categorías -->
      <h3 style="margin:.5rem 0">A) Carta descriptiva (1)</h3>
      <div class="grid grid-3">
        <div class="card">
          <h4><i class="fa-solid fa-file-alt" style="color:var(--primary)"></i> Carta descriptiva</h4>
          <p style="color:var(--muted)">Versión mejorada con taxonomía de Bloom, dominios y auditoría.</p>
          <div class="product-actions" style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/carta-descriptiva-completa.html',1)">Abrir</button>
          </div>
        </div>
      </div>

      <h3 style="margin:1.25rem 0">B) Manuales (2)</h3>
      <div class="grid grid-3">
        <div class="card">
          <h4><i class="fa-solid fa-book-open" style="color:var(--primary)"></i> Manual del participante</h4>
          <p style="color:var(--muted)">Contenido pedagógico, actividades y recursos.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/manual-participante.html',2)">Abrir</button>
          </div>
        </div>
        <div class="card">
          <h4><i class="fa-solid fa-chalkboard-user" style="color:var(--primary)"></i> Manual del instructor</h4>
          <p style="color:var(--muted)">Guías didácticas, conducción y metodologías.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/manual-instructor.html',3)">Abrir</button>
          </div>
        </div>
      </div>

      <h3 style="margin:1.25rem 0">C) Evaluaciones (4)</h3>
      <div class="grid grid-3">
        <div class="card">
          <h4><i class="fa-solid fa-clipboard-list" style="color:var(--primary)"></i> Diagnóstica</h4>
          <p style="color:var(--muted)">Medición de conocimientos previos.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/eval-diagnostica.html',4)">Abrir</button>
          </div>
        </div>
        <div class="card">
          <h4><i class="fa-solid fa-file-circle-check" style="color:var(--primary)"></i> Sumativa (+ hoja respuestas)</h4>
          <p style="color:var(--muted)">Examen final y hoja de respuestas integrada.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/eval-sumativa.html',5)">Abrir</button>
          </div>
        </div>
      <div class="card">
       <h4><i class="fa-solid fa-list-check" style="color:var(--primary)"></i> Evaluación Formativa</h4>
         <p style="color:var(--muted)">Lista de Cotejo o Guía de Observación (seleccionable)</p>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
          <button class="btn btn-primary" onclick="openDeliverable('/entregables/eval-formativa.html',6)">Abrir</button>
        </div>
        </div>
        <div class="card">
          <h4><i class="fa-solid fa-face-smile" style="color:var(--primary)"></i> Encuesta de satisfacción</h4>
          <p style="color:var(--muted)">Opinión del participante sobre el curso.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/eval-encuesta-satisfaccion.html',7)">Abrir</button>
          </div>
        </div>
      </div>

      <h3 style="margin:1.25rem 0">D) Logísticas (3)</h3>
      <div class="grid grid-3">
        <div class="card">
          <h4><i class="fa-solid fa-users" style="color:var(--primary)"></i> Lista de asistencia</h4>
          <p style="color:var(--muted)">Control de participación por sesión.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/log-lista-asistencia.html',8)">Abrir</button>
          </div>
        </div>
        <div class="card">
          <h4><i class="fa-solid fa-clipboard-check" style="color:var(--primary)"></i> Lista de verificación</h4>
          <p style="color:var(--muted)">Requerimientos del curso (aula/equipo).</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/log-lista-verificacion.html',9)">Abrir</button>
          </div>
        </div>
        <div class="card">
          <h4><i class="fa-solid fa-file-signature" style="color:var(--primary)"></i> Contrato de aprendizaje</h4>
          <p style="color:var(--muted)">Compromisos del participante.</p>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="badge badge-warn"><i class="fa-solid fa-clock"></i> Pendiente</span>
            <button class="btn btn-primary" onclick="openDeliverable('/entregables/log-contrato-aprendizaje.html',10)">Abrir</button>
          </div>
        </div>
      </div>

      <!-- Progreso global -->
      <div class="card" style="margin-top:1.5rem">
        <h3 class="section-title"><i class="fa-solid fa-magnifying-glass-chart"></i> Auditoría global</h3>
        <div class="progress"><div id="globalFill" class="fill"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:.5rem">
          <small style="color:var(--muted)">Cumplimiento EC0301</small>
          <strong id="globalPct">0%</strong>
        </div>
        <div style="margin-top:1rem">
          <button class="btn btn-secondary" onclick="runGlobalAudit()"><i class="fa-solid fa-search"></i> Ejecutar auditoría</button>
          <button id="genPortfolio" class="btn btn-primary" onclick="genPortfolio()" disabled><i class="fa-solid fa-file-zipper"></i> Generar portafolio</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Navegación simple por páginas
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.style.display='none');
      document.getElementById(id).style.display='block';
      window.scrollTo(0,0);
    }

    // Pago
    async function processPayment(e){
      e.preventDefault();
      const payload = {
        cardNumber: document.getElementById('cardNumber').value,
        cardName: document.getElementById('cardName').value,
        amount: 2500
      };
      try{
        const r = await fetch('/api/process-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const j = await r.json();
        if(!j.success) return toast(j.message,'err');
        toast('Pago procesado: '+j.transactionId,'ok');
        // Generar clave
        const g = await fetch('/api/generate-access-key',{method:'POST'});
        const k = await g.json();
        if(k.success){
          document.getElementById('accessKey').textContent = k.accessKey;
          document.getElementById('accessExpiry').textContent = 'Vigencia: '+ new Date(k.expiry).toLocaleDateString('es-MX');
          document.getElementById('regKey').value = k.accessKey;
          showPage('registration');
        }
      }catch(err){ toast('Error en pago','err'); }
    }

    // Registro
    async function completeRegistration(e){
      e.preventDefault();
      const payload = {
        name: document.getElementById('regName').value,
        email: document.getElementById('regEmail').value,
        whatsapp: document.getElementById('regWhats').value,
        accessKey: document.getElementById('regKey').value
      };
      try{
        const r = await fetch('/api/register-user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const j = await r.json();
        if(!j.success) return toast(j.message,'err');
        toast('Registro correcto','ok');
        showPage('dashboard');
      }catch(err){ toast('Error registrando','err'); }
    }

    // Abrir entregable
    const progressMap = {}; // id->porcentaje
    function openDeliverable(url, id){
      const w = window.open(url,'_blank','width=1400,height=900,scrollbars=yes,resizable=yes');
      if(!w){ toast('Permitir ventanas emergentes','warn'); return; }
      // Marcar avance inicial
      progressMap[id] = Math.max(progressMap[id]||0, 10);
      updateGlobal();
    }

    function runGlobalAudit(){
      // Sumar progreso: si una ventana terminó puede enviar postMessage en el futuro
      const total = [1,2,3,4,5,6,7,8,9,10].reduce((acc,i)=>acc+(progressMap[i]||0),0);
      const pct = Math.round(total/10);
      document.getElementById('globalFill').style.width = pct+'%';
      document.getElementById('globalPct').textContent = pct+'%';
      toast('Auditoría global ejecutada: '+pct+'%','ok');
      document.getElementById('genPortfolio').disabled = pct < 80;
    }

    function updateGlobal(){ // refresco barra
      const total = [1,2,3,4,5,6,7,8,9,10].reduce((acc,i)=>acc+(progressMap[i]||0),0);
      const pct = Math.round(total/10);
      document.getElementById('globalFill').style.width = pct+'%';
      document.getElementById('globalPct').textContent = pct+'%';
      document.getElementById('genPortfolio').disabled = pct < 80;
    }

    function genPortfolio(){
      const content = `PORTAFOLIO EC0301 - ${new Date().toLocaleDateString('es-MX')}
============================

Productos:
1) Carta descriptiva
2) Manual del participante
3) Manual del instructor
4) Evaluación diagnóstica
5) Evaluación sumativa (+ hoja de respuestas)
6) Guía/Lista de cotejo
7) Encuesta de satisfacción
8) Lista de asistencia
9) Lista de verificación de requerimientos
10) Contrato de aprendizaje

Cumplimiento global: ${document.getElementById('globalPct').textContent}
`;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content],{type:'text/plain'}));
      a.download = 'Portafolio_EC0301.txt';
      a.click();
      toast('Portafolio generado','ok');
    }
  </script>

  <!-- utilidades -->
  <script src="/assets/common.js"></script>
</body>
</html>
